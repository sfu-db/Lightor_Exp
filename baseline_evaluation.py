import sys
import os
import numpy as np
from utils import sec, time

ROOT_PATH = os.path.dirname(os.path.realpath('__file__'))

"""
we relabelled results generated by baseline because it has no "sliding window"
format (which we laballed in dataset) in our evaluation metrics (chat precision).
We tried to make a fair comparison with baseline here.
"""



def evaluate_baseline(k, file_name, dataset):
    path = os.path.join(ROOT_PATH, 'baseline_results', file_name)
    file_list = []
    try:
        file_list = os.listdir(path)
    except:
        print('No such file')
        return
    prec = [0] * k
    remaining = {}
    for f in file_list:
        data = np.load(os.path.join(path, f))
        data = [[data[0][d] / 30, (1 - data[2][d]) - (1 - 2 * data[2][d]) * data[-1][d]] for d in range(len(data[0]))]
        data = sorted(data, key=lambda x:-x[-1])
        pred = []
        while len(pred) < 10 and len(data) > 0:
            flag = True
            cur = data[0][0]
            del data[0]
            for p in pred:
                if abs(cur - p) < 120:
                    flag = False
                    break
            if flag:
                pred.append(cur)
        for i in range(1, k + 1):
            pre = pred[:i]
            prec[i - 1] += len([p for p in pre if p in dataset.start_gt[f.split('.')[0]]])
        remaining[f] = [p for p in pred[:10] if p not in dataset.start_gt[f.split('.')[0]]]
    return [prec[i] / ((i + 1) * len(file_list)) for i in range(k)], remaining
